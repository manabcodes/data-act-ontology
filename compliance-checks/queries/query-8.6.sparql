# ============================================================
# COMPLIANCE CHECK: Article 8(6) - Trade Secret Exception (B2B)
# ============================================================
# Regulation: EU Data Act (Regulation 2023/2854)
# Article: 8(6) - Trade secret exception in B2B sharing
# Type: B2B (Business-to-Business)
# Deontic: Permission (data holder MAY refuse if trade secret)
# ============================================================

PREFIX dataact: <http://www.semanticweb.org/dataact#>
PREFIX dpv: <https://w3c.github.io/dpv/2.2/dpv/#>
PREFIX odrl: <https://www.w3.org/ns/odrl/2/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Query returns violations where refusal to share is NOT justified
SELECT DISTINCT 
    ?b2bSharing 
    ?holder 
    ?recipient 
    ?data
    ?violationType
    ?details
WHERE {
  # ========== IDENTIFY B2B SCENARIO ==========
  ?b2bSharing a dataact:B2BDataSharing ;
              dataact:governedBy ?contract .
  
  # Get business recipient
  ?contract dpv:hasRecipient ?recipient .
  ?recipient a dataact:DataRecipient .
  
  # ========== CHECK AUTHORIZATION (Article 8.4) ==========
  # B2B sharing MUST be authorized by user
  ?b2bSharing dataact:authorizedBy ?user .
  ?user a dataact:User .
  
  # ========== CHECK DATA HOLDER ==========
  ?holder a dataact:DataHolder ;
          dpv:hasData ?data .
  ?data a dataact:ProductData .
  
  # ========== CHECK COMPLIANCE ==========
  
  {
    # VIOLATION TYPE 1: Data holder refused WITHOUT providing data
    FILTER NOT EXISTS {
      ?holder dataact:performsLegalAction ?provision .
      ?provision a dataact:DataProvision .
    }
    
    # BUT: Refusal is NOT justified by trade secret
    FILTER NOT EXISTS {
      ?data dataact:containsTradeSecret ?secret .
      ?secret a dataact:TradeSecretData .
    }
    
    BIND("UNJUSTIFIED_REFUSAL" AS ?violationType)
    BIND(CONCAT(
      "Article 8(6) VIOLATED: Data holder '", STR(?holder), 
      "' refused to share data with '", STR(?recipient), 
      "' but data does NOT contain trade secrets. ",
      "Refusal is only permitted when data constitutes trade secrets."
    ) AS ?details)
  }
  UNION
  {
    # VIOLATION TYPE 2: Missing user authorization (Article 8.4)
    FILTER NOT EXISTS {
      ?b2bSharing dataact:authorizedBy ?anyUser .
    }
    
    BIND("MISSING_AUTHORIZATION" AS ?violationType)
    BIND(CONCAT(
      "Article 8(4) VIOLATED: B2B data sharing '", STR(?b2bSharing), 
      "' lacks user authorization. ",
      "B2B sharing MUST be authorized by the user who owns/uses the product."
    ) AS ?details)
  }
}
ORDER BY ?violationType ?recipient

# ============================================================
# EXPECTED RESULTS:
# - COMPLIANT: Query returns 0 rows
#   * If data provision occurred → no violation
#   * If refusal occurred BUT data contains trade secret → justified
# 
# - NON-COMPLIANT: Query returns violations
#   * Refusal without trade secret justification
#   * Missing user authorization
#
# To test trade secret exception:
#   1. Comment out dataProvisionToMaintenance
#   2. Uncomment machineData1_WithSecret with trade secret
#   3. Query should return 0 (refusal is justified)
# ============================================================

# ============================================================
# ALTERNATIVE: ASK query to verify if refusal is legitimate
# ============================================================
# ASK {
#   ?data dataact:containsTradeSecret ?secret .
#   ?secret a dataact:TradeSecretData .
#   dataact:article8_6_rule dataact:permits ?permission .
#   ?permission a odrl:Permission .
# }
# Returns: true = refusal is justified, false = violation
# ============================================================