# ============================================================
# COMPLIANCE CHECK: Article 19(2)(a) - Prohibition on Competitive Use (B2G)
# ============================================================
# Regulation: EU Data Act (Regulation 2023/2854)
# Article: 19(2)(a) - Public body restrictions on data use
# Type: B2G (Business-to-Government)
# Deontic: Prohibition (public body MUST NOT compete)
# ============================================================

PREFIX dataact: <http://www.semanticweb.org/dataact#>
PREFIX dpv: <https://w3c.github.io/dpv/2.2/dpv/#>
PREFIX odrl: <https://www.w3.org/ns/odrl/2/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# Query returns violations where public body used data for competitive purposes
SELECT DISTINCT 
    ?b2gSharing 
    ?publicBody 
    ?holder
    ?action 
    ?violationType
    ?details
WHERE {
  # ========== IDENTIFY B2G SCENARIO ==========
  ?b2gSharing a dataact:B2GDataSharing ;
              dataact:governedBy ?contract .
  
  # Get public sector body (recipient)
  ?contract dpv:hasRecipient ?publicBody .
  ?publicBody a dataact:PublicSectorBody .
  
  # Get data holder (manufacturer/business)
  ?holder a dataact:DataHolder ;
          dpv:hasData ?data .
  
  # ========== CHECK EXCEPTIONAL NEED JUSTIFICATION ==========
  OPTIONAL {
    ?b2gSharing dataact:respondsTo ?exceptionalNeed .
    ?exceptionalNeed a dataact:ExceptionalNeed .
  }
  
  # ========== CHECK FOR VIOLATIONS ==========
  
  {
    # VIOLATION TYPE 1: Public body used data to develop competing product
    ?publicBody dataact:performsLegalAction ?action .
    
    # Direct type match
    ?action a dataact:UseDataToDevelopCompetingProduct .
    
    BIND("COMPETITIVE_PRODUCT_DEVELOPMENT" AS ?violationType)
    BIND(CONCAT(
      "Article 19(2)(a) VIOLATED: Public body '", STR(?publicBody), 
      "' performed action '", STR(?action), 
      "'. Public sector bodies MUST NOT use data to develop or enhance ",
      "connected products/services that compete with the data holder's offerings."
    ) AS ?details)
  }
  UNION
  {
    # VIOLATION TYPE 2: Detect by action description keywords
    ?publicBody dataact:performsLegalAction ?action .
    ?action dataact:hasDescription ?desc .
    
    # Filter for competitive development keywords
    FILTER(
      (CONTAINS(LCASE(?desc), "competing") || CONTAINS(LCASE(?desc), "compete")) &&
      (CONTAINS(LCASE(?desc), "develop") || 
       CONTAINS(LCASE(?desc), "enhance") || 
       CONTAINS(LCASE(?desc), "create"))
    )
    
    # Exclude legitimate uses
    FILTER(!CONTAINS(LCASE(?desc), "research only"))
    FILTER(!CONTAINS(LCASE(?desc), "non-commercial"))
    
    BIND("SUSPECTED_COMPETITIVE_USE" AS ?violationType)
    BIND(CONCAT(
      "Article 19(2)(a) POTENTIAL VIOLATION: Public body '", STR(?publicBody), 
      "' action description suggests competitive use: '", ?desc, 
      "'. Please verify if this constitutes prohibited competitive product development."
    ) AS ?details)
  }
  UNION
  {
    # VIOLATION TYPE 3: Missing exceptional need justification
    FILTER NOT EXISTS {
      ?b2gSharing dataact:respondsTo ?need .
      ?need a dataact:ExceptionalNeed .
    }
    
    BIND("MISSING_EXCEPTIONAL_NEED" AS ?violationType)
    BIND(CONCAT(
      "Article 14-15 VIOLATED: B2G data sharing '", STR(?b2gSharing), 
      "' lacks exceptional need justification. ",
      "B2G requests MUST respond to exceptional need (public emergency, etc.)."
    ) AS ?details)
  }
}
ORDER BY ?violationType ?publicBody

# ============================================================
# EXPECTED RESULTS:
# - COMPLIANT: Query returns 0 rows
#   * Public body receives data for legitimate purpose only
#   * No competitive product development
#   * Exceptional need is documented
# 
# - NON-COMPLIANT: Query returns violations
#   * Public body developed competing product
#   * Action description suggests competitive use
#   * Missing exceptional need justification
#
# LEGITIMATE USES (not violations):
#   - Research and statistical analysis
#   - Policy making
#   - Public health monitoring
#   - Emergency response coordination
#
# PROHIBITED USES (violations):
#   - Developing state-funded competing products
#   - Enhancing public sector services that compete
#   - Sharing insights with public competitors
# ============================================================

# ============================================================
# ALTERNATIVE: ASK query to check if prohibition exists
# ============================================================
# ASK {
#   dataact:Article19_2_a_rule a dataact:RegulativeRule ;
#                                dataact:prohibits ?prohibition .
#   ?prohibition a odrl:Prohibition ;
#                dataact:specifiesAction dataact:UseDataToDevelopCompetingProduct .
# }
# Returns: true = rule is properly encoded
# ============================================================

# ============================================================
# CHECK SPECIFIC PUBLIC BODY COMPLIANCE
# ============================================================
# To check if a specific public body violated Article 19(2)(a):
#
# SELECT ?action ?actionDesc WHERE {
#   dataact:nationalHealthAuthority dataact:performsLegalAction ?action .
#   ?action a dataact:UseDataToDevelopCompetingProduct .
#   OPTIONAL { ?action dataact:hasDescription ?actionDesc }
# }
# ============================================================